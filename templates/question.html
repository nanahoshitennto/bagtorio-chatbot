{% extends "base.html" %}

{% block content %}
<div class="chat-box" id="chat-container">
    <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chat-header">
        <img src="{{ url_for('static', filename='takeoka-icon.png') }}" alt="ãƒ­ã‚´" class="chat-logo">
        <p>
            æ­¦å²¡çš®è†šç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã®ãŠå•ã„åˆã‚ã›ãƒãƒ£ãƒƒãƒˆã§ã™ã€‚<br>
            ä¸‹è¨˜ã‚ˆã‚Šé¸æŠã„ãŸã ãã‹ã€è³ªå•å…¥åŠ›æ¬„ã«ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </p>
    </div>

    <!-- æœ€åˆã®è³ªå• -->
    <div class="question-box show" id="q{{ question[0] }}">
        <div class="chat-message">
            <div class="question-text">{{ question[1] }}</div>
        </div>
        <div class="options-grid">
            {% for option in options %}
                {% if option[1] and option[1] != 'None' %}
                    <a onclick="showNextQuestion('q{{ option[1] }}', '{{ option[0] }}', this)">{{ option[0] }}</a>
                {% else %}
                    <a onclick="showNextQuestion('qend', '{{ option[0] }}', this)">{{ option[0] }}</a>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- 2å•ç›®ä»¥é™ -->
    {% for q in all_questions %}
    <div class="question-box" id="q{{ q.id }}">
        <div class="chat-message">
            <div class="question-text">{{ q.question }}</div>
        </div>
        <div class="options-grid">
            {% for opt in q.options %}
                {% if opt.next_id and opt.next_id != 'None' %}
                    <a onclick="showNextQuestion('q{{ opt.next_id }}', '{{ opt.text }}', this)">{{ opt.text }}</a>
                {% else %}
                    <a onclick="showNextQuestion('qend', '{{ opt.text }}', this)">{{ opt.text }}</a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- å…¥åŠ›æ¬„ -->
<div class="chat-footer">
    <input type="text" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="chat-input">
    <button class="chat-send-btn">
        <img src="{{ url_for('static', filename='send-icon-blue.png') }}" alt="é€ä¿¡" class="send-icon">
    </button>
</div>

<!-- JavaScript ãƒ­ã‚¸ãƒƒã‚¯ -->
<script>
function showNextQuestion(nextId, selectedText, clickedElement) {
    if (!nextId || nextId === 'qNone' || nextId === 'None') {
        nextId = 'qend';
    }

    const chatContainer = document.getElementById("chat-container");

    // ğŸ”§ åŒã˜è³ªå•å†…ã®é¸æŠè‚¢ã‚’å–å¾—ã—ã¦ã€å…¨éƒ¨ç„¡åŠ¹åŒ–ï¼‹é¸æŠè§£é™¤
    const parentBox = clickedElement.closest(".question-box");
    const allOptions = parentBox.querySelectorAll("a");
    allOptions.forEach(btn => {
        btn.classList.add("disabled");
        btn.classList.remove("selected");
        btn.style.pointerEvents = "none";
    });

    // âœ… æŠ¼ã•ã‚ŒãŸé¸æŠè‚¢ã ã‘ã€Œé¸æŠæ¸ˆã¿ã€ã¨ã—ã¦é’è¡¨ç¤º
    clickedElement.classList.add("selected");

    // âœ… æ¬¡ã®è³ªå•ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
    const nextBox = document.getElementById(nextId);
    if (nextBox && !nextBox.classList.contains("show")) {
        const commentDiv = document.createElement("div");
        commentDiv.className = "chat-message chat-bot fade-in";
        commentDiv.innerHTML = `
            <div class="chat-header">
                <img src="{{ url_for('static', filename='takeoka-icon.png') }}" alt="ãƒ­ã‚´" class="chat-logo">
                <p>ã€Œ${selectedText}ã€ã§ã™ã­ã€‚ä»¥ä¸‹ã‹ã‚‰ãŠé¸ã³ãã ã•ã„ã€‚</p>
            </div>
        `;
        chatContainer.appendChild(commentDiv);

        nextBox.classList.add("show");
        chatContainer.appendChild(nextBox);
        nextBox.scrollIntoView({ behavior: 'smooth' });
    }

    // âœ… æœ€å¾Œã®è³ªå•ã ã£ãŸå ´åˆ
    if (nextId === 'qend') {
        const endDiv = document.createElement("div");
        endDiv.className = "chat-message chat-bot fade-in";
        endDiv.innerHTML = `
            <div class="chat-header">
                <img src="{{ url_for('static', filename='takeoka-icon.png') }}" alt="ãƒ­ã‚´" class="chat-logo">
                <p>æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™å ´åˆã¯ <a href="#" onclick="restartChat()" style="text-decoration: underline; color: #007BFF;">ã“ã¡ã‚‰</a></p>
            </div>
        `;
        chatContainer.appendChild(endDiv);
        endDiv.scrollIntoView({ behavior: 'smooth' });
    }
}

// âœ… ã‚„ã‚Šç›´ã—å‡¦ç†
function restartChat() {
    const chatContainer = document.getElementById("chat-container");

    // å…¨ã‚³ãƒ¡ãƒ³ãƒˆã¨è³ªå•ãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    const boxes = chatContainer.querySelectorAll(".question-box, .chat-message.chat-bot");
    boxes.forEach(box => {
        box.classList.remove("show");
        if (box.classList.contains("chat-message")) box.remove();
    });

    // æœ€åˆã®è³ªå•ã®ã¿è¡¨ç¤º
    const first = document.querySelector(".question-box");
    if (first) {
        first.classList.add("show");

        const buttons = first.querySelectorAll("a");
        buttons.forEach(btn => {
            btn.classList.remove("disabled", "selected");
            btn.style.pointerEvents = "";
        });

        first.scrollIntoView({ behavior: 'smooth' });
    }
}
</script>
{% endblock %}
